--@name Universal Datalink Root
--@author Ally for Hire / Merydian9
--@include ../public_lib/helpful_hud_functions.txt

--- Version 1.0.1

local CLIENTDISPLAY = true

if SERVER then
    local currentVehicleTracks = {}
    local currentMissileTracks = {}
    local currentTracks = {currentVehicleTracks, currentMissileTracks}
    local stayTime = {3, 1}
    
    local checkedIDs = {}
    local lastUpdate = timer.curtime()
    
    hook.add("remote", "Remote Response", function(sender, owner, payload)
        if sender == chip() then return end
    
        if payload == "Node Ping" then
            hook.runRemote(sender, "Master Response")
        elseif #payload > 0 then
            local positions = payload[1]
            local velocities = payload[2]
            local ids = payload[3]
            local owners = payload[4]
            local inputTime = payload[5]
            local tableType = payload[6]
    
            local curTime = timer.curtime()
            local curTable = currentTracks[tableType]
    
            checkedIDs = {}
    
            for i = 1, #positions do
                local id = ids[i]
                if curTable[id] == nil or curTable[id][4] < inputTime then
                    curTable[id] = {positions[i], velocities[i], owners[i], inputTime}
                    checkedIDs[id] = true
                end
            end
    
            for id, data in pairs(curTable) do
                if not checkedIDs[id] and (curTime - data[4]) > stayTime[tableType] then
                    --print("Purging outdated track:", id)
                    curTable[id] = nil
                end
            end
    
            wire.ports.Tracks = currentTracks[1]
    
            if CLIENTDISPLAY and (curTime - lastUpdate) > 0.1 then
                net.start("Server Variable Update")
                net.writeTable(currentTracks)
                net.send()
    
                lastUpdate = curTime
            end
        end
    end)
    
    hook.runRemote(nil, "Master Ping")
    
    wire.adjustPorts({}, {Tracks = "Table"})
elseif CLIENT and CLIENTDISPLAY then
    local currentVehicleTracks = {}
    local currentMissileTracks = {}
    local currentTracks = {currentVehicleTracks, currentMissileTracks}
    
    local lib = require("../public_lib/helpful_hud_functions.txt")
    
    local fontsmall = render.createFont("", 15, 1200, nil, nil, nil, true)
    
    enableHud(player(), true)
    
    local function renderHud()
        for key, value in pairs(currentVehicleTracks) do
            local pos = value[1]
            local x, y = pos:toScreen().x, pos:toScreen().y
            
            _setColor(COL_BLACK)
            render.drawRectRotated(x, y, 8, 8, 45)
            _setColor(COL_GREEN)
            render.drawRectRotated(x, y, 5, 5, 45)
            _setFont(fontsmall)
            -- _drawText(x, y - 7.5, key, TEXT_ALIGN.CENTER)
            _drawText(x + 10, y - 10 - 7.5, value[3])
            _drawText(x + 10, y + 10 - 7.5, math.round(value[2]:getLength() / 39.37) .. "M/S")
        end  
        
        for key, value in pairs(currentMissileTracks) do
            local pos = value[1]
            local x, y = pos:toScreen().x, pos:toScreen().y
            
            _setColor(COL_BLACK)
            drawCenterRect(x, y, 8, 4)
            drawCenterRect(x, y, 4, 8)
            _setColor(COL_RED)
            drawCenterRect(x, y, 5, 2)
            drawCenterRect(x, y, 2, 5)
            -- _drawCircle(x, y, 10)
            _setFont(fontsmall)
            _drawText(x + 10, y + 10 - 7.5, math.round(value[2]:getLength() / 39.37) .. "M/S")
        end    
    end
    
    net.receive("Server Variable Update", function()
        local data = net.readTable()
        currentVehicleTracks = data[1]
        currentMissileTracks = data[2]
        currentTracks = {currentVehicleTracks, currentMissileTracks}
    end)
    
    hook.add("drawhud", "Render HUD", renderHud)
end